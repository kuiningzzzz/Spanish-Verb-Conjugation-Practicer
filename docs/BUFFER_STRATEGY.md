# AI 流水线智能缓冲策略详解

## 📊 核心概念

### 缓冲区 (Buffer)
保持提前生成的题目数量，确保用户答题时下一题已准备好。

**配置参数：**
- `bufferSize: 2` - 缓冲区大小（保持当前题 + 后续 2 题）
- `maxConcurrent: 2` - 最大并发生成数

### 状态追踪
- `currentIndex` - 当前答题位置（0-based）
- `exercises.length` - 已生成题目总数
- `generatingCount` - 正在生成中的题目数
- `exerciseCount` - 总题目数（如 10）

## 🔄 缓冲区填充算法

### 核心逻辑
```javascript
fillBuffer() {
  // 1. 计算目标位置
  bufferTarget = currentIndex + 1 + bufferSize
  // 示例：当前第 3 题，缓冲 2 题 → 目标是准备好第 6 题
  
  // 2. 计算缺口
  gap = bufferTarget - exercises.length - generatingCount
  // 示例：目标第 6 题，已有 4 题，正在生成 1 题 → 缺 1 题
  
  // 3. 考虑总题数限制
  remaining = exerciseCount - exercises.length - generatingCount
  // 示例：总共 10 题，已有 4 题，正在生成 1 题 → 还能生成 5 题
  
  // 4. 考虑并发限制
  concurrentSlots = maxConcurrent - generatingCount
  // 示例：最大并发 2，正在生成 1 → 还能启动 1 个
  
  // 5. 取最小值
  toGenerate = Math.min(gap, remaining, concurrentSlots)
  
  // 6. 启动生成任务
  for (i = 0; i < toGenerate; i++) {
    generateNextExercise()
  }
}
```

## 📈 实际运行示例

### 场景 1：正常答题（每题 5 秒）

| 时刻 | 当前题 | 已生成 | 生成中 | 缓冲区状态 | 动作 |
|------|-------|--------|--------|-----------|------|
| T0 | - | 0 | 0 | 空 | 开始练习 |
| T1 | 0 | 1 | 0 | [1] | 生成第1题完成 |
| T2 | 0 | 1 | 2 | [1, 生成2, 生成3] | fillBuffer() 启动2个任务 |
| T3 | 0 | 3 | 0 | [1, 2, 3] | 第2、3题生成完成 |
| T8 | 1 | 3 | 2 | [2, 3, 生成4, 生成5] | 答完第1题，fillBuffer() |
| T9 | 1 | 5 | 0 | [2, 3, 4, 5] | 第4、5题完成 |
| T14 | 2 | 5 | 2 | [3, 4, 5, 生成6, 生成7] | 答完第2题 |
| ... | ... | ... | ... | ... | 持续流水线 |

**结果：** 全程无等待，缓冲区始终充足

---

### 场景 2：快速答题（每题 1 秒）

| 时刻 | 当前题 | 已生成 | 生成中 | 缓冲区状态 | 动作 |
|------|-------|--------|--------|-----------|------|
| T0 | - | 0 | 0 | 空 | 开始练习 |
| T1 | 0 | 1 | 0 | [1] | 第1题生成完成 |
| T2 | 0 | 1 | 2 | [1, 生成2, 生成3] | fillBuffer() |
| T2.5 | 1 | 1 | 2 | [生成2, 生成3] | **快速答完第1题，下一题未就绪** |
| T2.5+ | 1 | 1 | 2 | 等待中... | 显示"AI 正在生成..." |
| T3 | 1 | 2 | 1 | [2, 生成3] | 第2题完成，自动跳转 |
| T3+ | 1 | 2 | 2 | [2, 生成3, 生成4] | fillBuffer() 补充 |
| T4 | 2 | 3 | 1 | [3, 生成4] | 答完第2题（第3题已就绪） |
| T4+ | 2 | 3 | 2 | [3, 生成4, 生成5] | 持续填充 |
| T5 | 3 | 4 | 1 | [4, 生成5] | 后续恢复流畅 |

**结果：** 第 1→2 题时等待 0.5 秒，后续流畅

---

### 场景 3：极速答题 + 大缓冲区

配置：`bufferSize: 4`, `maxConcurrent: 3`

| 时刻 | 当前题 | 已生成 | 生成中 | 缓冲区状态 | 动作 |
|------|-------|--------|--------|-----------|------|
| T0 | 0 | 1 | 0 | [1] | 第1题完成 |
| T1 | 0 | 1 | 3 | [1, 生成2-4] | fillBuffer() 启动3个任务 |
| T2 | 1 | 4 | 3 | [2, 3, 4, 生成5-7] | 答完第1题，继续生成 |
| T3 | 2 | 7 | 3 | [3, 4, 5, 6, 7, 生成8-10] | 缓冲区充足 |

**结果：** 极速答题也无等待

## 🎯 优化策略对比

| 策略 | 缓冲大小 | 并发数 | API 调用数 | 等待概率 | 适用场景 |
|------|---------|--------|-----------|---------|---------|
| 保守 | 1 | 1 | 最少 | 中 | 慢速答题，节省成本 |
| **标准** | **2** | **2** | **适中** | **低** | **推荐，平衡性能和成本** |
| 激进 | 4 | 3 | 较多 | 极低 | 快速答题，追求极致体验 |
| 批量 | 10 | - | 一次性 | 无（答题中） | 传统模式，前置等待长 |

## 🔍 调试技巧

### 查看缓冲区状态
在浏览器控制台：
```javascript
// 当前答题位置
this.currentIndex

// 已生成题目数
this.exercises.length

// 正在生成数
this.generatingCount

// 缓冲区实际容量
this.exercises.length - this.currentIndex - 1

// 应有缓冲容量
this.bufferSize
```

### 监控填充逻辑
添加调试日志：
```javascript
fillBuffer() {
  const bufferTarget = this.currentIndex + 1 + this.bufferSize
  const gap = bufferTarget - this.exercises.length - this.generatingCount
  
  console.log(`[Buffer] 当前: ${this.currentIndex}, 已有: ${this.exercises.length}, 生成中: ${this.generatingCount}`)
  console.log(`[Buffer] 目标: ${bufferTarget}, 缺口: ${gap}`)
  
  // ... 其余逻辑
}
```

## 💡 性能优化建议

### 1. 根据用户画像调整
- **新手用户**：答题慢，`bufferSize: 1` 节省 API
- **熟练用户**：答题快，`bufferSize: 3` 避免等待

### 2. 根据题型调整
- **选择题**：答题快，增加缓冲
- **填空题**：答题慢，减少缓冲

### 3. 根据 AI 响应时间调整
- **API 响应 < 1秒**：可降低缓冲，实时生成
- **API 响应 > 3秒**：必须增加缓冲，避免等待

### 4. 动态自适应
```javascript
// 记录最近 3 题的答题时间
const recentAnswerTimes = []

// 计算平均时间
const avgTime = recentAnswerTimes.reduce((a,b) => a+b) / 3

// 动态调整缓冲
if (avgTime < 2) {
  this.bufferSize = 3  // 快速答题，增加缓冲
} else if (avgTime > 5) {
  this.bufferSize = 1  // 慢速答题，减少缓冲
}
```

## 📊 数据统计指标

建议收集以下数据优化策略：

1. **等待次数**：用户在答题过程中等待的次数
2. **等待时长**：每次等待的平均时长
3. **缓冲区命中率**：跳题时下一题已就绪的比例
4. **浪费率**：生成但未使用的题目比例（用户中途退出）
5. **平均答题时间**：每题的平均耗时

**理想指标：**
- 等待次数 < 5%
- 缓冲区命中率 > 95%
- 浪费率 < 10%

## ⚙️ 配置建议总结

| 用户类型 | bufferSize | maxConcurrent | 说明 |
|---------|-----------|---------------|------|
| 默认 | 2 | 2 | 推荐配置，适合大部分用户 |
| 快速答题者 | 3-4 | 3 | 高并发，大缓冲 |
| 慢速答题者 | 1 | 1 | 节省 API，按需生成 |
| 网络不稳定 | 3 | 2 | 大缓冲，中等并发 |
| 移动端 | 2 | 1 | 节省流量，适中缓冲 |
